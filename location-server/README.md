# FreeBSD's Installation

These scripts auto-install FreeBSD, baseline harden it, and configure it with 3 jails. See
the diagrams and more details at: https://blog.uxtly.com/freebsd-jails-network-setup

The configuration files in this directory match the structure they're going to be
in the final server. They are tarred beforehand, and copied over to your
laptop's `/tmp/UxtelyInstallerConfigs/setups/`, along with the installer scripts.

Then, you'll have to serve that at: `https://orch.example.com/setups/`. Yes,
**only one location server can be created at a time.**

Each script part ends up printing a banner. If it doesn't print, something
went wrong. For that, the scripts have `set -o errexit`, and a few tests,
but not much tracing information. Also, each script gets deleted if it
didn't fail; so you can check for that too (if you missed the banners).

### Temporary dummy files
These files are just to allow the jails to boot up without issues during the installation.
- `nginx_j` **needs** TLS certificates
  - put them in `jails_j/usr/local/DistBundles/certs/` (see [nginx.conf](./jails/nginx_j/usr/local/etc/nginx/nginx.conf))
- `node_j` has a temp `main.js`


### init-location-installer-bundle.sh
From your laptop, it creates the installation scripts and configs.

Overview:
- Prompts for general info (IP, GW, Host Username, etc.)
- Creates local SSH Keys
- Creates a disk encryption password
- Copies the config tars, keys, and installer scripts


### installerconfig.sh
Manually triggered in the server with: 
```shell script
/usr/sbin/bsdinstall script /tmp/installerconfig.sh
```
- Installs the OS
- ↓ Downloads and runs `installerconfig-part2.sh`

### installerconfig-part2.sh
- Untars the configs, creates jails, installs updates, etc. 
- ↓ Downloads and extracts `base.tar` and `jails.tar`
- ↓ Downloads `installerconfig-part3.sh` and sets it to run on the next boot
- Reboots

### installerconfig-part3.sh (first boot)
- Runs the `/setup.sh` of each jail. 
    - Each one installs jail packages and configures the jail. 
- Creates the root passwords, which get tarred in the home directory.

All this is done on the first boot. That's because it's easier to use paths like
`/jails` instead of `/mnt/jails`. That is, the `bsdinstall` is chroot'd under `/mnt`.


## Special Configs
Although `/location-server` has most of the files, (installation
scripts, and configs) there are a few exceptions:

- `postgres.conf` and `pg_hba.conf` are generated by the `/jails/pg_j/setup.sh`
- Common configs, like the timezone file, are copied over
to the template jail by `installerconfig-part2.sh`

The following files get modified in-place:
- The jails' `rc.conf` by their corresponding `/setup.sh`


## Troubleshooting

### Install
The `bsdinstall` error popup eats away any useful error message from the screen. To see
the error messages, add `/bin/sh` or `sleep 60` at the end of any of the first two parts.

Common problems:
- The orchestration server is not up
- Some device didn't unmount like `/dev/cd`
  - `pwait` or `sleep 2` help to finish killing some processes. 


### Login to "Location Servers"
By design (our policy):
- SSH Login:
	- `root` **can't** login via SSH.
	- Normal users **can only** login via SSH.
- Console Login using Hivelocity's IPMI over their VPN
	- Only `root` **can** login through the console.
	- Normal users **can't** because their passwords are starred (*).
